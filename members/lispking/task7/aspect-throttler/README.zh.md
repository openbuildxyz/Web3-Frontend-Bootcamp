# 限流器 Aspect（简化版）

这是 [ShiningRay](https://github.com/ShiningRay/) 提供的限流器 Aspect 的简化版，用于限制某些智能合约的请求速率。

**典型场景**：
- 在空投中，限制每个地址的领取频率。
- 对于有影响力的项目，保护其免受 DDoS 攻击。

## 解决的问题

在很多场景中， 我们不希望某些特定的接口、方法被频繁调用， 因此提出了限流的概念。 例如， 在网页前端使用键入同时触发搜索的功能， 为了防止用户频繁触发搜索， 我们可以设置一个时间间隔， 在这个时间间隔内， 用户只能触发一次搜索。
同样在区块链中， 也有类似的场景： 例如， 在空投中， 我们不希望用户频繁领取空投， 因此， 我们可以设置一个时间间隔在这个时间间隔内， 用户只能领取一次空投。

## 项目设计

### 实现

通过 Aspect 的 `mutableState` 储存方法的调用信息，并在 `PreContractCall` 切点中检查方法调用的频率。如果超过限制，交易将被中止。

### 与纯 EVM 实现的对比

EVM生态中可以在合约中实现限流功能， 但如果合约尚未考虑限流逻辑的话， 升级合约相对麻烦， 通过 Aspect 可以在不修改合约的情况下， 为合约增加限流功能。

## 运行方式

### 创建地址

```bash
$ npm run account:create
address:  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
```

脚本将在项目目录中创建一个名为 `privateKey.txt` 的私钥文件。您也可以输入自己的私钥。记录下您的地址，然后您可以去 Artela 的 Discord 水龙头中申请测试币。

### 编译和部署合约

```bash
$ npm run contract:build

$ npm run contract:deploy

> contract:deploy
> node scripts/contract-deploy.cjs --name Counter

from address:  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
deploy contract tx hash: 0x14535f7ce3739d029cb2c806d7c57befb68ba303c0d6699b45b161dd94cc7bfc
{
  blockHash: '0x1860a3e94dcf5cc77590ad8c3a85b7a9818cae869c51ca33b21028579dc80637',
  blockNumber: 8781296,
  contractAddress: '0x4A679253410272dd5232B3Ff7cF5dbB88f295319',
  cumulativeGasUsed: 9832642,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 7000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: null,
  transactionHash: '0x14535f7ce3739d029cb2c806d7c57befb68ba303c0d6699b45b161dd94cc7bfc',
  transactionIndex: 6,
  type: '0x0'
}
contract address:  0x4A679253410272dd5232B3Ff7cF5dbB88f295319
--contractAccount 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --contractAddress 0x4A679253410272dd5232B3Ff7cF5dbB88f295319
```

记住最后部署的合约地址，以便后续绑定。

### 编译 Aspect

```bash
$ npm run aspect:build
```

构建好之后，运行部署脚本。

```bash
$ node scripts/aspect-deploy.cjs --interval 5 --limit 2

from address:  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
[
  { key: 'interval', value: Uint8Array(2) [ 0, 5 ] },
  { key: 'limit', value: Uint8Array(2) [ 0, 2 ] }
]
sending signed transaction...
{
  blockHash: '0x8b9c4cb10f64fc183b4cc85a3485d867415eb08c00634e42a0c5334d4ca9098d',
  blockNumber: 8781338,
  contractAddress: null,
  cumulativeGasUsed: 4862977,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 9000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x0000000000000000000000000000000000a27e14',
  transactionHash: '0x1128741cf08c5a30e347548087424615dc36e36f982e0264ed212dcb2e2536f1',
  transactionIndex: 3,
  type: '0x0',
  aspectAddress: '0x7a2088a1bFc9d81c55368AE168C2C02570cB814F'
}
ret:  {
  blockHash: '0x8b9c4cb10f64fc183b4cc85a3485d867415eb08c00634e42a0c5334d4ca9098d',
  blockNumber: 8781338,
  contractAddress: null,
  cumulativeGasUsed: 4862977,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 9000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x0000000000000000000000000000000000a27e14',
  transactionHash: '0x1128741cf08c5a30e347548087424615dc36e36f982e0264ed212dcb2e2536f1',
  transactionIndex: 3,
  type: '0x0',
  aspectAddress: '0x7a2088a1bFc9d81c55368AE168C2C02570cB814F'
}
== deployed aspectID == 0x7a2088a1bFc9d81c55368AE168C2C02570cB814F
```

参数为：

- interval：限流区块数量间隔
- limit：每个间隔最多能执行的次数

记住最后的 aspectID，以便后续绑定。

### 绑定

执行 `bind.cjs` 脚本，并代入之前部署的合约地址（或者自己的合约地址）和 aspectID。

```bash
$ node scripts/bind.cjs --contract 0x4A679253410272dd5232B3Ff7cF5dbB88f295319 --aspectId 0x7a2088a1bFc9d81c55368AE168C2C02570cB814F

sending signed transaction...
{
  blockHash: '0xda943d8ae8ef36ca2ec5dbeafe2bbe6ae15d2365c48560e1fdd45796b4287d8a',
  blockNumber: 8781393,
  contractAddress: null,
  cumulativeGasUsed: 846561,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 9000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x0000000000000000000000000000000000a27e14',
  transactionHash: '0x16906291031bfbd62c44c73e4d98bb6021078400ac054532798148371754b8f7',
  transactionIndex: 3,
  type: '0x0'
}
== aspect bind success ==
```

然后我们可以执行查询合约绑定的 Aspect 的脚本，检查合约是否绑定成功。

```bash
$ node scripts/get-bound-aspect.cjs --contract 0x4A679253410272dd5232B3Ff7cF5dbB88f295319
bound aspects : 0x7a2088a1bFc9d81c55368AE168C2C02570cB814F,1,1
```

输出中显示了上述的 aspectID，表示已经成功绑定。

### 测试

`scripts/batch-test.cjs` 会批量发送合约交易，用以测试限流功能。

```bash
$ node scripts/batch-test.cjs

from address:  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
#0
call contract tx hash: 0x68b0c7aa1670b776168c8ee85b243fa41a7c1c5a8222ce0f689d691b5cc47b55
{
  blockHash: '0xbe121b5092f4119e47218b86c20245b1cf70082ab70c946d5e5b807f20000e72',
  blockNumber: 8781470,
  contractAddress: null,
  cumulativeGasUsed: 6048679,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 4000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x8042470214c92b938f723e3f0aa067fb299e19b3',
  transactionHash: '0x68b0c7aa1670b776168c8ee85b243fa41a7c1c5a8222ce0f689d691b5cc47b55',
  transactionIndex: 2,
  type: '0x0'
}
#1
call contract tx hash: 0xd6ef95a1a51775baa70f2a5f710b2133533fd705f0be406f3f0e19e01aeaa82b
{
  blockHash: '0x158f7d138d8e781f5952426bd3fdb3c163797b87b16fec7ce55d38dc538fad79',
  blockNumber: 8781472,
  contractAddress: null,
  cumulativeGasUsed: 2000000,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 4000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x8042470214c92b938f723e3f0aa067fb299e19b3',
  transactionHash: '0xd6ef95a1a51775baa70f2a5f710b2133533fd705f0be406f3f0e19e01aeaa82b',
  transactionIndex: 0,
  type: '0x0'
}
#2
call contract tx hash: 0x9e32101333a18c872246f636ae96bdd4329dbc1bb649eda2c38acd3a277b99d0
{
  blockHash: '0x2ada71ca6c674ad9eb8331810fcd4ae8038fd77a0eef05efbe815fdc43ef2267',
  blockNumber: 8781474,
  contractAddress: null,
  cumulativeGasUsed: 6176639,
  from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
  gasUsed: 4000001,
  logs: [],
  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x8042470214c92b938f723e3f0aa067fb299e19b3',
  transactionHash: '0x9e32101333a18c872246f636ae96bdd4329dbc1bb649eda2c38acd3a277b99d0',
  transactionIndex: 3,
  type: '0x0'
}
#3
call contract tx hash: 0x456270766ba7203f3275e6ef723188215add80ce59f1fc67ae6f959fecca03bf
transaction throttled, let's wait for 10 seconds: Transaction has been reverted by the EVM:
{
  "blockHash": "0x4829663a6f30e719258d0ee3470e78a6a8213ae1e39b498a1dbcfc2140275484",
  "blockNumber": 8781476,
  "contractAddress": null,
  "cumulativeGasUsed": 2895760,
  "from": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266",
  "gasUsed": 4000001,
  "logs": [],
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "status": false,
  "to": "0x8042470214c92b938f723e3f0aa067fb299e19b3",
  "transactionHash": "0x456270766ba7203f3275e6ef723188215add80ce59f1fc67ae6f959fecca03bf",
  "transactionIndex": 4,
  "type": "0x0"
}
#4
call contract tx hash: 0x124580050eeb1d705878ccd9e81044e55270d7b6e57282273e6fb80daa73574f
transaction throttled, let's wait for 10 seconds: Transaction has been reverted by the EVM:
{
  "blockHash": "0xb4dbd0fd4e7791e49dd0fffdbc54c2efa901871ec02a9e3c32ccc44a557e08cb",
  "blockNumber": 8781478,
  "contractAddress": null,
  "cumulativeGasUsed": 2484444,
  "from": "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266",
  "gasUsed": 4000001,
  "logs": [],
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "status": false,
  "to": "0x8042470214c92b938f723e3f0aa067fb299e19b3",
  "transactionHash": "0x124580050eeb1d705878ccd9e81044e55270d7b6e57282273e6fb80daa73574f",
  "transactionIndex": 3,
  "type": "0x0"
}
```

脚本返回报错，表示限流器成功阻止了交易的成功。
